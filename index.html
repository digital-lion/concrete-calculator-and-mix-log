<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concrete Mix Calculator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --muted-green: #7d8471;
            --muted-blue: #6b7d8a;
            --terracotta: #c17a5b;
            --black: #1a1a1a;
            --white: #ffffff;
            --light-gray: #f8faf9;
            --border-light: #e8ede9;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px;
            background: linear-gradient(135deg, #f8faf9 0%, #e8ede9 100%);
            min-height: 100vh;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
        }
        
        .container {
            background: var(--white);
            border-radius: 0;
            padding: 32px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            border: 1px solid var(--border-light);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                margin-bottom: 12px;
            }
        }
        
        h1 {
            color: var(--black);
            font-weight: 600;
            font-size: 28px;
            margin-bottom: 32px;
            position: relative;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
                text-align: center;
            }
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--muted-green) 0%, var(--muted-blue) 100%);
            border-radius: 2px;
        }
        
        h2 {
            color: var(--muted-green);
            font-weight: 500;
            font-size: 20px;
            margin-top: 32px;
            margin-bottom: 20px;
        }
        
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 16px;
            }
        }
        
        .input-section, .output-section {
            background: var(--light-gray);
            padding: 24px;
            border-radius: 0;
            border: 1px solid var(--border-light);
        }
        
        @media (max-width: 768px) {
            .input-section, .output-section {
                padding: 16px;
            }
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        .input-group input[type="number"] {
            margin-bottom: 8px;
        }
        
        .volume-waste-row input[type="number"] {
            margin-right: 10px;
        }
        
        .ratio-inputs input[type="number"] {
            margin-right: 8px;
        }
        
        .density-grid input[type="number"] {
            margin-right: 8px;
        }
        
        .volume-waste-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .volume-waste-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        
        label {
            display: block;
            font-weight: 500;
            color: var(--black);
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input[type="number"] {
            width: 80px !important;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 0;
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--white);
            margin: 3px 10px 3px 0 !important;
        }
        
        @media (max-width: 768px) {
            input[type="number"] {
                width: calc(100% - 24px) !important;
                margin: 3px 0 !important;
                padding: 10px 12px;
                font-size: 16px; /* Prevents zoom on iOS */
                box-sizing: border-box;
            }
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: var(--muted-green);
            box-shadow: 0 0 0 3px rgba(125, 132, 113, 0.1);
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--muted-green);
            margin-right: 8px;
        }
        
        .ratio-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        @media (max-width: 480px) {
            .ratio-inputs {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        .pigment-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .pigment-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .pigment-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
        }
        
        .pigment-grid input {
            width: 100%;
            padding: 8px 6px;
            font-size: 12px;
            margin: 2px 0;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .pigment-grid input {
                padding: 10px 12px;
                font-size: 16px;
            }
        }
        
        .pigment-grid label {
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .density-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        @media (max-width: 480px) {
            .density-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        .plasticizer-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 480px) {
            .plasticizer-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
        
        .plasticizer-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .plasticizer-input input {
            width: 80px;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .plasticizer-input input {
                width: 100px;
            }
        }
        
        .output-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--white);
            border-radius: 0;
            margin-bottom: 8px;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }
        
        .output-item:hover {
            box-shadow: 0 2px 8px rgba(125, 132, 113, 0.1);
            border-color: var(--muted-green);
        }
        
        .output-value {
            font-weight: 600;
            color: var(--muted-green);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .button {
            background: linear-gradient(135deg, var(--muted-green) 0%, #8b9a7d 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 0;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2px;
            box-shadow: 0 2px 8px rgba(125, 132, 113, 0.2);
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(125, 132, 113, 0.3);
        }
        
        .button-secondary {
            background: linear-gradient(135deg, var(--muted-blue) 0%, #7a8b98 100%);
        }
        
        .button-danger {
            background: linear-gradient(135deg, var(--terracotta) 0%, #d18b6c 100%);
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 4px 0;
        }
        
        .save-controls {
            background: var(--white);
            padding: 16px;
            border-radius: 0;
            border: 1px solid var(--border-light);
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(26, 26, 26, 0.04);
        }
        
        .controls-title-compact {
            font-size: 16px;
            font-weight: 600;
            color: var(--black);
            margin: 0 0 12px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
        }
        
        .dropdown-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .dropdown-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .button-sections {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 16px;
            align-items: start;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0;
        }
        
        @media (max-width: 768px) {
            .button-sections {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .button-sections.expanded {
                max-height: 400px;
                padding-top: 12px;
            }
        }
        
        .button-sections.expanded {
            max-height: 200px;
            padding-top: 12px;
        }
        
        .button-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .section-label {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .button-group-compact {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        
        @media (max-width: 768px) {
            .button-group-compact {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        .button-group-single {
            display: flex;
        }
        
        .btn-compact {
            padding: 8px 12px;
            border: none;
            border-radius: 0;
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            .btn-compact {
                padding: 12px 16px;
                font-size: 12px;
                white-space: normal;
                text-align: center;
            }
        }
        
        .btn-compact-blue {
            background: linear-gradient(135deg, var(--muted-blue) 0%, #7a8b98 100%);
            color: white;
        }
        
        .btn-compact-green {
            background: linear-gradient(135deg, var(--muted-green) 0%, #8b9a7d 100%);
            color: white;
        }
        
        .btn-compact-danger {
            background: linear-gradient(135deg, var(--terracotta) 0%, #d18b6c 100%);
            color: white;
        }
        
        .btn-compact:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .file-input {
            margin: 4px 0;
        }
        
        .file-input label {
            font-size: 11px;
            color: var(--black);
            margin-bottom: 2px;
        }
        
        .file-input input[type="file"] {
            margin: 2px 0;
            font-size: 10px;
        }
        
        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        
        .log-table th, .log-table td {
            border: 1px solid #dee2e6;
            padding: 6px;
            text-align: center;
            vertical-align: top;
        }
        
        .log-table th {
            background: linear-gradient(135deg, var(--muted-green) 0%, #8b9a7d 100%);
            color: white;
            font-weight: 500;
            font-size: 13px;
            cursor: grab;
            user-select: none;
        }
        
        .log-table th:active {
            cursor: grabbing;
        }
        
        .log-table th.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .log-table th.drag-over {
            border-left: 4px solid var(--muted-blue);
            background: linear-gradient(135deg, var(--muted-blue) 0%, #7a8b98 100%);
        }
        
        .log-table .parameter-cell {
            background: var(--light-gray);
            font-weight: 500;
            text-align: right;
            width: 200px;
            position: sticky;
            left: 0;
            z-index: 1;
            color: var(--black);
            border-right: 2px solid var(--muted-green);
            padding-right: 12px;
        }
        
        .log-table td:not(.parameter-cell) {
            text-align: center;
        }
        
        .log-table input[type="text"], .log-table input[type="number"], .log-table input[type="date"] {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px;
            font-size: 11px;
            text-align: center;
            margin: 2px;
        }
        
        .log-table input[type="checkbox"] {
            transform: scale(1.2);
            margin: 2px;
        }
        
        .delete-mix-btn {
            background: var(--terracotta);
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 0;
            font-size: 10px;
            cursor: pointer;
            margin: 1px;
        }
        
        .delete-mix-btn:hover {
            background: #bf360c;
        }
        
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        
        @media (max-width: 768px) {
            .table-container {
                font-size: 11px;
            }
            
            .log-table {
                font-size: 10px;
                min-width: 600px; /* Ensure table doesn't get too cramped */
            }
            
            .log-table th, .log-table td {
                padding: 4px;
            }
            
            .log-table .parameter-cell {
                width: 100px;
                font-size: 9px;
                padding-right: 6px;
            }
            
            .log-table input[type="text"], 
            .log-table input[type="number"], 
            .log-table input[type="date"] {
                font-size: 10px;
                padding: 2px;
            }
        }
        
        .reference-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .reference-box {
            background: var(--light-gray);
            padding: 20px;
            border-radius: 0;
            border-left: 4px solid var(--muted-green);
        }
        
        .reference-box h3 {
            color: var(--black);
            margin-top: 0;
            font-weight: 500;
        }
        
        .alert {
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8dc 100%);
            border: 1px solid var(--terracotta);
            border-radius: 0;
            padding: 12px 16px;
            margin: 16px 0;
            color: #bf360c;
            font-weight: 500;
        }
        
        .success-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border: 1px solid var(--muted-green);
            color: #2e7d32;
            padding: 6px 8px;
            border-radius: 0;
            margin: 4px 0;
            display: none;
            font-size: 10px;
        }
        
        .error-message {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 1px solid var(--terracotta);
            color: #c62828;
            padding: 6px 8px;
            border-radius: 0;
            margin: 4px 0;
            display: none;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Concrete Calculator & Mix Log</h1>
        
        <!-- Save/Load Controls -->
        <div class="save-controls">
            <h3 class="controls-title-compact" onclick="toggleDropdown()">
                Save & Load Data
                <span class="dropdown-arrow">‚ñº</span>
            </h3>
            <div class="button-sections" id="buttonSections">
                <div class="button-section">
                    <div class="section-label">Local</div>
                    <div class="button-group-compact">
                        <button class="btn-compact btn-compact-blue" onclick="saveData()">Save Local</button>
                        <button class="btn-compact btn-compact-blue" onclick="document.getElementById('fileInput').click()">Load Local</button>
                        <button class="btn-compact btn-compact-blue" onclick="exportData()">Export JSON</button>
                        <button class="btn-compact btn-compact-blue" onclick="exportCSV()">Export CSV</button>
                    </div>
                </div>
                
                <div class="button-section">
                    <div class="section-label">Google Drive</div>
                    <div class="button-group-compact">
                        <button class="btn-compact btn-compact-green" onclick="initGoogleDrive()" id="authButton">Connect to Drive</button>
                        <button class="btn-compact btn-compact-green" onclick="saveToGoogleDrive()" id="saveToGDrive" style="display:none;">Save to Drive</button>
                        <button class="btn-compact btn-compact-green" onclick="loadFromGoogleDrive()" id="loadFromGDrive" style="display:none;">Load from Drive</button>
                        <button class="btn-compact btn-compact-green" onclick="signOutGoogleDrive()" id="signOutButton" style="display:none;">Sign Out</button>
                    </div>
                </div>
                
                <div class="button-section">
                    <div class="section-label">Reset</div>
                    <div class="button-group-single">
                        <button class="btn-compact btn-compact-danger" onclick="clearAllData()">Clear All Data</button>
                    </div>
                </div>
            </div>
            <div id="driveStatus" style="font-size: 11px; color: #666; margin-top: 5px;"></div>
            <input type="file" id="fileInput" accept=".json" onchange="loadData(event)" style="display: none;">
            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>
        </div>
        
        <div class="calculator-grid">
            <div class="input-section">
                <h2>Input Parameters</h2>
                
                <div class="input-group">
                    <label>Volume & Waste</label>
                    <div class="volume-waste-row">
                        <div>
                            <label for="volume">Mold Volume (cubic inches)</label>
                            <input type="number" id="volume" step="0.1" value="10" oninput="calculate()">
                        </div>
                        <div>
                            <label for="waste">Waste Factor (%)</label>
                            <input type="number" id="waste" step="1" value="10" min="0" max="50" oninput="calculate()">
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Mix Ratio (Portland : Sand : Water)</label>
                    <div class="ratio-inputs">
                        <input type="number" id="ratioPortland" step="0.1" value="1" placeholder="Portland" oninput="calculate()">
                        <input type="number" id="ratioSand" step="0.1" value="2" placeholder="Sand" oninput="calculate()">
                        <input type="number" id="ratioWater" step="0.1" value="1" placeholder="Water" oninput="calculate()">
                    </div>
                </div>

                <div class="input-group">
                    <label>Plasticizer</label>
                    <div class="plasticizer-controls">
                        <input type="checkbox" id="plasticizerEnabled" onchange="togglePlasticizer()" checked>
                        <label for="plasticizerEnabled" style="margin: 0;">Use Plasticizer</label>
                        <div class="plasticizer-input" id="plasticizerInputs">
                            <input type="number" id="plasticizerPercent" step="0.01" value="0.21" min="0" max="5" oninput="calculate()">
                            <span>% of cement weight</span>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Pigment Percentages (% of cement weight)</label>
                    <div class="pigment-grid">
                        <div>
                            <label for="pigmentBlack">Black %</label>
                            <input type="number" id="pigmentBlack" step="0.1" value="0" min="0" max="10" oninput="calculate()">
                        </div>
                        <div>
                            <label for="pigmentBlue">Blue %</label>
                            <input type="number" id="pigmentBlue" step="0.1" value="0" min="0" max="10" oninput="calculate()">
                        </div>
                        <div>
                            <label for="pigmentGreen">Green %</label>
                            <input type="number" id="pigmentGreen" step="0.1" value="0" min="0" max="10" oninput="calculate()">
                        </div>
                        <div>
                            <label for="pigmentOrange">Orange %</label>
                            <input type="number" id="pigmentOrange" step="0.1" value="0" min="0" max="10" oninput="calculate()">
                        </div>
                        <div>
                            <label for="pigmentBrown">Brown %</label>
                            <input type="number" id="pigmentBrown" step="0.1" value="0" min="0" max="10" oninput="calculate()">
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Material Densities (g/cm¬≥)</label>
                    <div class="density-grid">
                        <div>
                            <label for="densityCement">Cement</label>
                            <input type="number" id="densityCement" step="0.001" value="1.505" oninput="calculate()">
                        </div>
                        <div>
                            <label for="densitySand">Sand</label>
                            <input type="number" id="densitySand" step="0.001" value="1.602" oninput="calculate()">
                        </div>
                        <div>
                            <label for="densityWater">Water</label>
                            <input type="number" id="densityWater" step="0.001" value="1.0" oninput="calculate()">
                        </div>
                    </div>
                </div>
                
                <div class="alert" id="pigmentAlert" style="display: none;">
                    ‚ö†Ô∏è Total pigment exceeds 10% of cement weight
                </div>
            </div>
            
            <div class="output-section">
                <h2>Calculated Amounts (grams)</h2>
                
                <div class="output-item">
                    <span>Cement:</span>
                    <span class="output-value" id="outputCement">0 g</span>
                </div>
                <div class="output-item">
                    <span>Sand:</span>
                    <span class="output-value" id="outputSand">0 g</span>
                </div>
                <div class="output-item">
                    <span>Water:</span>
                    <span class="output-value" id="outputWater">0 g</span>
                </div>
                <div class="output-item">
                    <span>Pigment Black:</span>
                    <span class="output-value" id="outputPigmentBlack">0 g</span>
                </div>
                <div class="output-item">
                    <span>Pigment Blue:</span>
                    <span class="output-value" id="outputPigmentBlue">0 g</span>
                </div>
                <div class="output-item">
                    <span>Pigment Green:</span>
                    <span class="output-value" id="outputPigmentGreen">0 g</span>
                </div>
                <div class="output-item">
                    <span>Pigment Orange:</span>
                    <span class="output-value" id="outputPigmentOrange">0 g</span>
                </div>
                <div class="output-item">
                    <span>Pigment Brown:</span>
                    <span class="output-value" id="outputPigmentBrown">0 g</span>
                </div>
                <div class="output-item">
                    <span>Plasticizer:</span>
                    <span class="output-value" id="outputPlasticizer">0 g</span>
                </div>
                <div class="output-item" style="border-top: 2px solid var(--muted-green); font-weight: bold;">
                    <span>Total Mix Weight:</span>
                    <span class="output-value" id="outputTotal">0 g</span>
                </div>
                
                <button class="button" onclick="sendToLog()" style="width: 100%; margin-top: 20px; padding: 12px 24px; font-size: 14px;">üìã SEND TO LOG</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <h2>Mix Log</h2>
        
        <div class="table-container">
            <table class="log-table" id="logTable">
                <thead>
                    <tr>
                        <th class="parameter-cell">Parameter</th>
                        <th draggable="true" ondragstart="dragStart(event, 1)" ondragover="dragOver(event)" ondrop="dropColumn(event, 1)" ondragend="dragEnd(event)">Mix #1 <button class="delete-mix-btn" onclick="deleteMix(1)">√ó</button></th>
                        <th draggable="true" ondragstart="dragStart(event, 2)" ondragover="dragOver(event)" ondrop="dropColumn(event, 2)" ondragend="dragEnd(event)">Mix #2 <button class="delete-mix-btn" onclick="deleteMix(2)">√ó</button></th>
                        <th draggable="true" ondragstart="dragStart(event, 3)" ondragover="dragOver(event)" ondrop="dropColumn(event, 3)" ondragend="dragEnd(event)">Mix #3 <button class="delete-mix-btn" onclick="deleteMix(3)">√ó</button></th>
                        <th draggable="true" ondragstart="dragStart(event, 4)" ondragover="dragOver(event)" ondrop="dropColumn(event, 4)" ondragend="dragEnd(event)">Mix #4 <button class="delete-mix-btn" onclick="deleteMix(4)">√ó</button></th>
                        <th draggable="true" ondragstart="dragStart(event, 5)" ondragover="dragOver(event)" ondrop="dropColumn(event, 5)" ondragend="dragEnd(event)">Mix #5 <button class="delete-mix-btn" onclick="deleteMix(5)">√ó</button></th>
                        <th draggable="true" ondragstart="dragStart(event, 6)" ondragover="dragOver(event)" ondrop="dropColumn(event, 6)" ondragend="dragEnd(event)">Mix #6 <button class="delete-mix-btn" onclick="deleteMix(6)">√ó</button></th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td class="parameter-cell">Cast Date</td><td><input type="date" onchange="updateDaysSinceCast(this, 1)"></td><td><input type="date" onchange="updateDaysSinceCast(this, 2)"></td><td><input type="date" onchange="updateDaysSinceCast(this, 3)"></td><td><input type="date" onchange="updateDaysSinceCast(this, 4)"></td><td><input type="date" onchange="updateDaysSinceCast(this, 5)"></td><td><input type="date" onchange="updateDaysSinceCast(this, 6)"></td></tr>
                    <tr><td class="parameter-cell">Days Since Cast</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Ratio (P:S:W)</td><td><input type="text" readonly></td><td><input type="text" readonly></td><td><input type="text" readonly></td><td><input type="text" readonly></td><td><input type="text" readonly></td><td><input type="text" readonly></td></tr>
                    <tr><td class="parameter-cell">Adjusted Volume (in¬≥)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">% Pigment Total</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Cement (g)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Sand (g)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Water (g)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Pigment Black (g)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Pigment Blue (g)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Pigment Green (g)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Pigment Orange (g)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Pigment Brown (g)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Plasticizer (g)</td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td><td><input type="number" readonly></td></tr>
                    <tr><td class="parameter-cell">Slurry Coat</td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td></tr>
                    <tr><td class="parameter-cell">Vibration Method</td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td class="parameter-cell">Mix Notes</td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td class="parameter-cell"></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td class="parameter-cell">Bubble Rating (1-10)</td><td><input type="number" min="1" max="10"></td><td><input type="number" min="1" max="10"></td><td><input type="number" min="1" max="10"></td><td><input type="number" min="1" max="10"></td><td><input type="number" min="1" max="10"></td><td><input type="number" min="1" max="10"></td></tr>
                    <tr><td class="parameter-cell">Surface Quality</td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td class="parameter-cell">Color Evenness</td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td class="parameter-cell">Sealer Used</td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
                    <tr><td class="parameter-cell">Final Impressions</td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Google Drive API Script -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // Dropdown toggle function
        function toggleDropdown() {
            const sections = document.getElementById('buttonSections');
            const arrow = document.querySelector('.dropdown-arrow');
            
            sections.classList.toggle('expanded');
            arrow.classList.toggle('expanded');
        }
        
        // Google Drive API Configuration
        const CLIENT_ID = '350363016695-9itltindfq1hfg72e6tofvqpeshf09tt.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBVvpHKO1Xh463eemDZliTCvuk8n6tQebg';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILENAME = 'concrete-calculator-data.json';
        
        let tokenClient;
        let google_drive_ready = false;
        let google_drive_file_id = null;
        
        // Initialize Google Drive API
        async function initGoogleDrive() {
            // Check if we're running on file:// protocol
            if (window.location.protocol === 'file:') {
                showMessage('error', 'Google Drive requires HTTPS. Please serve this file through a web server or use localhost.');
                return;
            }
            
            try {
                console.log('Initializing Google Drive...');
                
                // Initialize gapi client
                await new Promise((resolve) => {
                    gapi.load('client', resolve);
                });
                
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                
                console.log('gapi client initialized');
                
                // Initialize Google Identity Services
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: async (resp) => {
                        console.log('OAuth response:', resp);
                        if (resp.error !== undefined) {
                            showMessage('error', 'Google Drive authentication failed: ' + resp.error);
                            return;
                        }
                        
                        google_drive_ready = true;
                        updateDriveUI();
                        showMessage('success', 'Connected to Google Drive!');
                        await findOrCreateFile();
                    },
                });
                
                console.log('Token client created, requesting access...');
                tokenClient.requestAccessToken({prompt: 'consent'});
                
            } catch (error) {
                console.error('Error initializing Google Drive:', error);
                showMessage('error', 'Error connecting to Google Drive: ' + error.message);
            }
        }
        
        function updateDriveUI() {
            document.getElementById('authButton').style.display = 'none';
            document.getElementById('saveToGDrive').style.display = 'inline-flex';
            document.getElementById('loadFromGDrive').style.display = 'inline-flex';
            document.getElementById('signOutButton').style.display = 'inline-flex';
            
            if (google_drive_file_id) {
                document.getElementById('driveStatus').textContent = `‚úÖ Connected - File: ${FILENAME}`;
            } else {
                document.getElementById('driveStatus').textContent = 'üîç Connected - Searching for file...';
            }
        }
        
        function signOutGoogleDrive() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            google_drive_ready = false;
            google_drive_file_id = null;
            
            document.getElementById('authButton').style.display = 'inline-flex';
            document.getElementById('saveToGDrive').style.display = 'none';
            document.getElementById('loadFromGDrive').style.display = 'none';
            document.getElementById('signOutButton').style.display = 'none';
            document.getElementById('driveStatus').textContent = '';
            
            showMessage('success', 'Signed out from Google Drive');
        }
        
        // Find existing file or create new one
        async function findOrCreateFile() {
            try {
                console.log('Searching for existing file...');
                // Search for existing file
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILENAME}' and parents in 'root'`,
                    fields: 'files(id, name)'
                });
                
                if (response.result.files.length > 0) {
                    google_drive_file_id = response.result.files[0].id;
                    document.getElementById('driveStatus').textContent = `‚úÖ Connected - File: ${FILENAME}`;
                    showMessage('success', 'Found existing data file in Google Drive');
                } else {
                    // Create new file with empty structure
                    await createNewFile();
                }
            } catch (error) {
                console.error('Error finding file:', error);
                showMessage('error', 'Error connecting to Google Drive: ' + error.message);
            }
        }
        
        async function createNewFile() {
            try {
                console.log('Creating new file...');
                
                // Create empty data structure
                const emptyData = {
                    calculator: getCalculatorData(),
                    mixLog: [],
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(emptyData, null, 2);
                
                const metadata = {
                    name: FILENAME,
                    parents: ['root']
                };
                
                // Create file with content
                const response = await gapi.client.request({
                    path: 'https://www.googleapis.com/upload/drive/v3/files',
                    method: 'POST',
                    params: {
                        uploadType: 'multipart'
                    },
                    headers: {
                        'Content-Type': 'multipart/related; boundary="foo_bar_baz"'
                    },
                    body: [
                        '--foo_bar_baz',
                        'Content-Type: application/json; charset=UTF-8',
                        '',
                        JSON.stringify(metadata),
                        '--foo_bar_baz',
                        'Content-Type: application/json',
                        '',
                        dataStr,
                        '--foo_bar_baz--'
                    ].join('\r\n')
                });
                
                google_drive_file_id = JSON.parse(response.body).id;
                document.getElementById('driveStatus').textContent = `‚úÖ Connected - File: ${FILENAME} (New)`;
                showMessage('success', 'Created new data file in Google Drive');
            } catch (error) {
                console.error('Error creating file:', error);
                showMessage('error', 'Error creating file: ' + error.message);
            }
        }
        
        // Save data to Google Drive
        async function saveToGoogleDrive() {
            if (!google_drive_ready || !google_drive_file_id) {
                showMessage('error', 'Please connect to Google Drive first');
                return;
            }
            
            try {
                const data = {
                    calculator: getCalculatorData(),
                    mixLog: getMixLogData(),
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                
                const response = await gapi.client.request({
                    path: `https://www.googleapis.com/upload/drive/v3/files/${google_drive_file_id}`,
                    method: 'PATCH',
                    params: {
                        uploadType: 'media'
                    },
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: dataStr
                });
                
                showMessage('success', 'Data saved to Google Drive successfully!');
            } catch (error) {
                console.error('Error saving to Drive:', error);
                showMessage('error', 'Error saving to Google Drive: ' + error.message);
            }
        }
        
        // Load data from Google Drive
        async function loadFromGoogleDrive() {
            if (!google_drive_ready || !google_drive_file_id) {
                showMessage('error', 'Please connect to Google Drive first');
                return;
            }
            
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: google_drive_file_id,
                    alt: 'media'
                });
                
                const data = JSON.parse(response.body);
                
                setCalculatorData(data.calculator);
                setMixLogData(data.mixLog);
                calculate();
                
                showMessage('success', `Data loaded from Google Drive! (${new Date(data.timestamp).toLocaleString()})`);
            } catch (error) {
                console.error('Error loading from Drive:', error);
                showMessage('error', 'Error loading from Google Drive: ' + error.message);
            }
        }
        
        function calculate() {
            // Get input values
            const volume = parseFloat(document.getElementById('volume').value) || 0;
            const ratioPortland = parseFloat(document.getElementById('ratioPortland').value) || 1;
            const ratioSand = parseFloat(document.getElementById('ratioSand').value) || 2;
            const ratioWater = parseFloat(document.getElementById('ratioWater').value) || 1;
            const wasteFactor = parseFloat(document.getElementById('waste').value) || 0;
            const plasticizerPercent = parseFloat(document.getElementById('plasticizerPercent').value) || 0.21;
            
            const pigmentBlack = parseFloat(document.getElementById('pigmentBlack').value) || 0;
            const pigmentBlue = parseFloat(document.getElementById('pigmentBlue').value) || 0;
            const pigmentGreen = parseFloat(document.getElementById('pigmentGreen').value) || 0;
            const pigmentOrange = parseFloat(document.getElementById('pigmentOrange').value) || 0;
            const pigmentBrown = parseFloat(document.getElementById('pigmentBrown').value) || 0;
            
            // Material densities (adjustable)
            const densityCement = parseFloat(document.getElementById('densityCement').value) || 1.505;
            const densitySand = parseFloat(document.getElementById('densitySand').value) || 1.602;
            const densityWater = parseFloat(document.getElementById('densityWater').value) || 1.0;
            
            // Convert cubic inches to cm¬≥
            const volumeCm3 = volume * 16.387;
            
            // Apply waste factor
            const adjustedVolume = volumeCm3 * (1 + wasteFactor / 100);
            
            // Calculate total ratio parts
            const totalRatio = ratioPortland + ratioSand + ratioWater;
            
            // Calculate volume for each component
            const cementVolume = (ratioPortland / totalRatio) * adjustedVolume;
            const sandVolume = (ratioSand / totalRatio) * adjustedVolume;
            const waterVolume = (ratioWater / totalRatio) * adjustedVolume;
            
            // Calculate weights
            const cementWeight = cementVolume * densityCement;
            const sandWeight = sandVolume * densitySand;
            const waterWeight = waterVolume * densityWater;
            
            // Calculate plasticizer weight (only if enabled)
            const plasticizerEnabled = document.getElementById('plasticizerEnabled').checked;
            const plasticizerWeight = plasticizerEnabled ? (plasticizerPercent / 100) * cementWeight : 0;
            
            // Calculate pigment weights (as percentage of cement weight)
            const pigmentBlackWeight = (pigmentBlack / 100) * cementWeight;
            const pigmentBlueWeight = (pigmentBlue / 100) * cementWeight;
            const pigmentGreenWeight = (pigmentGreen / 100) * cementWeight;
            const pigmentOrangeWeight = (pigmentOrange / 100) * cementWeight;
            const pigmentBrownWeight = (pigmentBrown / 100) * cementWeight;
            
            // Check total pigment percentage
            const totalPigmentPercent = pigmentBlack + pigmentBlue + pigmentGreen + pigmentOrange + pigmentBrown;
            const alertElement = document.getElementById('pigmentAlert');
            if (totalPigmentPercent > 10) {
                alertElement.style.display = 'block';
            } else {
                alertElement.style.display = 'none';
            }
            
            // Calculate total weight
            const totalWeight = cementWeight + sandWeight + waterWeight + plasticizerWeight +
                              pigmentBlackWeight + pigmentBlueWeight + pigmentGreenWeight + 
                              pigmentOrangeWeight + pigmentBrownWeight;
            
            // Update output displays
            document.getElementById('outputCement').textContent = Math.round(cementWeight * 10) / 10 + ' g';
            document.getElementById('outputSand').textContent = Math.round(sandWeight * 10) / 10 + ' g';
            document.getElementById('outputWater').textContent = Math.round(waterWeight * 10) / 10 + ' g';
            document.getElementById('outputPlasticizer').textContent = Math.round(plasticizerWeight * 10) / 10 + ' g';
            document.getElementById('outputPigmentBlack').textContent = Math.round(pigmentBlackWeight * 10) / 10 + ' g';
            document.getElementById('outputPigmentBlue').textContent = Math.round(pigmentBlueWeight * 10) / 10 + ' g';
            document.getElementById('outputPigmentGreen').textContent = Math.round(pigmentGreenWeight * 10) / 10 + ' g';
            document.getElementById('outputPigmentOrange').textContent = Math.round(pigmentOrangeWeight * 10) / 10 + ' g';
            document.getElementById('outputPigmentBrown').textContent = Math.round(pigmentBrownWeight * 10) / 10 + ' g';
            document.getElementById('outputTotal').textContent = Math.round(totalWeight * 10) / 10 + ' g';
            
            // Auto-save after calculation
            autoSave();
        }
        
        function togglePlasticizer() {
            const enabled = document.getElementById('plasticizerEnabled').checked;
            const inputs = document.getElementById('plasticizerInputs');
            
            if (enabled) {
                inputs.style.display = 'flex';
            } else {
                inputs.style.display = 'none';
                document.getElementById('plasticizerPercent').value = '0';
            }
            calculate();
        }
        
        function updateDaysSinceCast(dateInput, mixNumber) {
            if (dateInput.value) {
                const castDate = new Date(dateInput.value);
                const today = new Date();
                const timeDiff = today.getTime() - castDate.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                
                const tbody = document.getElementById('logTable').getElementsByTagName('tbody')[0];
                const daysSinceRow = tbody.getElementsByTagName('tr')[1];
                const daysSinceInput = daysSinceRow.getElementsByTagName('input')[mixNumber - 1];
                daysSinceInput.value = daysDiff >= 0 ? daysDiff : '';
            }
            autoSave();
        }
        
        function sendToLog() {
            const table = document.getElementById('logTable');
            
            // Count current columns to determine next mix number
            const headerRow = table.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
            const currentCols = headerRow.getElementsByTagName('th').length - 1; // Subtract 1 for parameter column
            
            // Find the first empty column instead of always adding new
            let columnIndex = -1;
            const tbody = table.getElementsByTagName('tbody')[0];
            const firstRow = tbody.getElementsByTagName('tr')[0]; // Cast Date row
            
            for (let i = 0; i < currentCols; i++) {
                const input = firstRow.getElementsByTagName('input')[i];
                if (!input.value) {
                    columnIndex = i;
                    break;
                }
            }
            
            // If no empty column found, add new column
            if (columnIndex === -1) {
                addNewMixColumn();
                columnIndex = currentCols;
            }
            
            // Get current calculator values
            const volume = parseFloat(document.getElementById('volume').value) || 0;
            const wasteFactor = parseFloat(document.getElementById('waste').value) || 0;
            const adjustedVolumeInches = volume * (1 + wasteFactor / 100);
            
            const ratioPortland = parseFloat(document.getElementById('ratioPortland').value) || 1;
            const ratioSand = parseFloat(document.getElementById('ratioSand').value) || 2;
            const ratioWater = parseFloat(document.getElementById('ratioWater').value) || 1;
            const pigmentTotal = (parseFloat(document.getElementById('pigmentBlack').value) || 0) +
                               (parseFloat(document.getElementById('pigmentBlue').value) || 0) +
                               (parseFloat(document.getElementById('pigmentGreen').value) || 0) +
                               (parseFloat(document.getElementById('pigmentOrange').value) || 0) +
                               (parseFloat(document.getElementById('pigmentBrown').value) || 0);
            
            // Get calculated values from the output
            const cementWeight = parseFloat(document.getElementById('outputCement').textContent.replace(' g', ''));
            const sandWeight = parseFloat(document.getElementById('outputSand').textContent.replace(' g', ''));
            const waterWeight = parseFloat(document.getElementById('outputWater').textContent.replace(' g', ''));
            const plasticizerWeight = parseFloat(document.getElementById('outputPlasticizer').textContent.replace(' g', ''));
            const pigmentBlackWeight = parseFloat(document.getElementById('outputPigmentBlack').textContent.replace(' g', ''));
            const pigmentBlueWeight = parseFloat(document.getElementById('outputPigmentBlue').textContent.replace(' g', ''));
            const pigmentGreenWeight = parseFloat(document.getElementById('outputPigmentGreen').textContent.replace(' g', ''));
            const pigmentOrangeWeight = parseFloat(document.getElementById('outputPigmentOrange').textContent.replace(' g', ''));
            const pigmentBrownWeight = parseFloat(document.getElementById('outputPigmentBrown').textContent.replace(' g', ''));
            
            // Fill in the log table
            const dataRows = tbody.getElementsByTagName('tr');
            
            // Set today's date
            dataRows[0].getElementsByTagName('input')[columnIndex].value = new Date().toISOString().split('T')[0];
            
            // Auto-calculate days since cast (will be 0 for today)
            updateDaysSinceCast(dataRows[0].getElementsByTagName('input')[columnIndex], columnIndex + 1);
            
            // Fill calculated values - FIXED: Make sure we're setting the ratio correctly
            const ratioInput = dataRows[2].getElementsByTagName('input')[columnIndex];
            ratioInput.value = `${ratioPortland}:${ratioSand}:${ratioWater}`;
            
            dataRows[3].getElementsByTagName('input')[columnIndex].value = adjustedVolumeInches.toFixed(2);
            dataRows[4].getElementsByTagName('input')[columnIndex].value = pigmentTotal.toFixed(1);
            dataRows[5].getElementsByTagName('input')[columnIndex].value = cementWeight.toFixed(1);
            dataRows[6].getElementsByTagName('input')[columnIndex].value = sandWeight.toFixed(1);
            dataRows[7].getElementsByTagName('input')[columnIndex].value = waterWeight.toFixed(1);
            dataRows[8].getElementsByTagName('input')[columnIndex].value = pigmentBlackWeight.toFixed(1);
            dataRows[9].getElementsByTagName('input')[columnIndex].value = pigmentBlueWeight.toFixed(1);
            dataRows[10].getElementsByTagName('input')[columnIndex].value = pigmentGreenWeight.toFixed(1);
            dataRows[11].getElementsByTagName('input')[columnIndex].value = pigmentOrangeWeight.toFixed(1);
            dataRows[12].getElementsByTagName('input')[columnIndex].value = pigmentBrownWeight.toFixed(1);
            dataRows[13].getElementsByTagName('input')[columnIndex].value = plasticizerWeight.toFixed(1);
            
            // Show success message
            showMessage('success', `Mix data sent to Mix #${columnIndex + 1}!`);
            
            // Scroll to the log table
            document.getElementById('logTable').scrollIntoView({ behavior: 'smooth' });
            
            // Auto-save
            autoSave();
        }
        
        
        // Drag and Drop functionality
        let draggedColumnIndex = null;
        
        function dragStart(event, columnIndex) {
            draggedColumnIndex = columnIndex;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        }
        
        function dragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            // Add visual feedback
            if (event.target.tagName === 'TH' && !event.target.classList.contains('parameter-cell')) {
                event.target.classList.add('drag-over');
            }
        }
        
        function dragEnd(event) {
            event.target.classList.remove('dragging');
            
            // Remove all drag-over classes
            const headers = document.querySelectorAll('.log-table th');
            headers.forEach(header => header.classList.remove('drag-over'));
        }
        
        function dropColumn(event, targetColumnIndex) {
            event.preventDefault();
            
            if (draggedColumnIndex === null || draggedColumnIndex === targetColumnIndex) {
                return;
            }
            
            const table = document.getElementById('logTable');
            const headerRow = table.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
            const tbody = table.getElementsByTagName('tbody')[0];
            
            // Get all data from the dragged column
            const columnData = [];
            const rows = tbody.getElementsByTagName('tr');
            
            // Extract data from dragged column
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (draggedColumnIndex < cells.length) {
                    const cell = cells[draggedColumnIndex];
                    const input = cell.querySelector('input');
                    let value = '';
                    
                    if (input) {
                        if (input.type === 'checkbox') {
                            value = input.checked;
                        } else {
                            value = input.value;
                        }
                    }
                    columnData.push(value);
                }
            }
            
            // Remove the dragged column
            headerRow.deleteCell(draggedColumnIndex);
            for (let i = 0; i < rows.length; i++) {
                rows[i].deleteCell(draggedColumnIndex);
            }
            
            // Adjust target index if dragging from left to right
            let adjustedTargetIndex = targetColumnIndex;
            if (draggedColumnIndex < targetColumnIndex) {
                adjustedTargetIndex--;
            }
            
            // Insert the column at the new position
            const newHeader = document.createElement('th');
            newHeader.draggable = true;
            newHeader.innerHTML = `Mix #${adjustedTargetIndex} <button class="delete-mix-btn" onclick="deleteMix(${adjustedTargetIndex})">√ó</button>`;
            newHeader.setAttribute('ondragstart', `dragStart(event, ${adjustedTargetIndex})`);
            newHeader.setAttribute('ondragover', 'dragOver(event)');
            newHeader.setAttribute('ondrop', `dropColumn(event, ${adjustedTargetIndex})`);
            newHeader.setAttribute('ondragend', 'dragEnd(event)');
            
            if (adjustedTargetIndex >= headerRow.cells.length) {
                headerRow.appendChild(newHeader);
            } else {
                headerRow.insertBefore(newHeader, headerRow.cells[adjustedTargetIndex]);
            }
            
            // Insert data cells
            for (let i = 0; i < rows.length; i++) {
                const newCell = document.createElement('td');
                const value = columnData[i];
                
                // Determine input type based on row
                if (i === 0) { // Cast Date
                    newCell.innerHTML = `<input type="date" onchange="updateDaysSinceCast(this, ${adjustedTargetIndex})">`;
                    if (value) newCell.querySelector('input').value = value;
                } else if (i === 2) { // Ratio - readonly text (FIXED: Handle this before the number check)
                    newCell.innerHTML = '<input type="text" readonly>';
                    if (value) newCell.querySelector('input').value = value;
                } else if ([1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13].includes(i)) { // Readonly calculated fields
                    newCell.innerHTML = '<input type="number" readonly>';
                    if (value) newCell.querySelector('input').value = value;
                } else if (i === 14) { // Slurry Coat checkbox
                    newCell.innerHTML = '<input type="checkbox">';
                    if (typeof value === 'boolean') newCell.querySelector('input').checked = value;
                } else if (i === 17) { // Empty row
                    newCell.innerHTML = '';
                } else if (i === 18) { // Bubble Rating
                    newCell.innerHTML = '<input type="number" min="1" max="10">';
                    if (value) newCell.querySelector('input').value = value;
                } else { // Text fields
                    newCell.innerHTML = '<input type="text">';
                    if (value) newCell.querySelector('input').value = value;
                }
                
                if (adjustedTargetIndex >= rows[i].cells.length) {
                    rows[i].appendChild(newCell);
                } else {
                    rows[i].insertBefore(newCell, rows[i].cells[adjustedTargetIndex]);
                }
            }
            
            // Renumber all columns
            renumberColumns();
            
            draggedColumnIndex = null;
            showMessage('success', `Column moved successfully!`);
            autoSave();
        }
        
        function renumberColumns() {
            const table = document.getElementById('logTable');
            const headerRow = table.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
            const tbody = table.getElementsByTagName('tbody')[0];
            const headers = headerRow.getElementsByTagName('th');
            
            // Renumber headers and update event handlers
            for (let i = 1; i < headers.length; i++) { // Start from 1 to skip parameter column
                const mixNumber = i;
                headers[i].innerHTML = `Mix #${mixNumber} <button class="delete-mix-btn" onclick="deleteMix(${mixNumber})">√ó</button>`;
                headers[i].setAttribute('ondragstart', `dragStart(event, ${mixNumber})`);
                headers[i].setAttribute('ondrop', `dropColumn(event, ${mixNumber})`);
            }
            
            // Update date input handlers
            const dateInputs = tbody.getElementsByTagName('tr')[0].getElementsByTagName('input');
            for (let i = 0; i < dateInputs.length; i++) {
                dateInputs[i].setAttribute('onchange', `updateDaysSinceCast(this, ${i + 1})`);
            }
        }
        
        function addNewMixColumn() {
            const table = document.getElementById('logTable');
            const headerRow = table.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
            const tbody = table.getElementsByTagName('tbody')[0];
            
            const mixNumber = headerRow.getElementsByTagName('th').length; // Current number including parameter column
            
            // Add header with delete button and drag functionality
            const newHeader = document.createElement('th');
            newHeader.draggable = true;
            newHeader.innerHTML = `Mix #${mixNumber} <button class="delete-mix-btn" onclick="deleteMix(${mixNumber})">√ó</button>`;
            newHeader.setAttribute('ondragstart', `dragStart(event, ${mixNumber})`);
            newHeader.setAttribute('ondragover', 'dragOver(event)');
            newHeader.setAttribute('ondrop', `dropColumn(event, ${mixNumber})`);
            newHeader.setAttribute('ondragend', 'dragEnd(event)');
            headerRow.appendChild(newHeader);
            
            // Add cells to main log table
            const rows = tbody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const newCell = document.createElement('td');
                
                // Determine input type based on row
                if (i === 0) { // Cast Date
                    newCell.innerHTML = `<input type="date" onchange="updateDaysSinceCast(this, ${mixNumber})">`;
                } else if ([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13].includes(i)) { // Readonly calculated fields
                    newCell.innerHTML = '<input type="number" readonly>';
                } else if (i === 14) { // Slurry Coat checkbox
                    newCell.innerHTML = '<input type="checkbox">';
                } else if (i === 2) { // Ratio - readonly text
                    newCell.innerHTML = '<input type="text" readonly>';
                } else if (i === 17) { // Empty row
                    newCell.innerHTML = '';
                } else if (i === 18) { // Bubble Rating
                    newCell.innerHTML = '<input type="number" min="1" max="10">';
                } else { // Text fields
                    newCell.innerHTML = '<input type="text">';
                }
                
                rows[i].appendChild(newCell);
            }
        }
        
        function deleteMix(mixNumber) {
            if (confirm(`Are you sure you want to delete Mix #${mixNumber}? This cannot be undone.`)) {
                const table = document.getElementById('logTable');
                const headerRow = table.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
                const tbody = table.getElementsByTagName('tbody')[0];
                
                // Remove header column
                headerRow.deleteCell(mixNumber);
                
                // Remove cells from all rows in main table
                const rows = tbody.getElementsByTagName('tr');
                for (let i = 0; i < rows.length; i++) {
                    rows[i].deleteCell(mixNumber);
                }
                
                // Renumber remaining headers and update delete buttons
                const headers = headerRow.getElementsByTagName('th');
                for (let i = 1; i < headers.length; i++) { // Start from 1 to skip parameter column
                    headers[i].innerHTML = `Mix #${i} <button class="delete-mix-btn" onclick="deleteMix(${i})">√ó</button>`;
                }
                
                // Update onchange handlers for date inputs
                const dateInputs = tbody.getElementsByTagName('tr')[0].getElementsByTagName('input');
                for (let i = 0; i < dateInputs.length; i++) {
                    dateInputs[i].setAttribute('onchange', `updateDaysSinceCast(this, ${i + 1})`);
                }
                
                showMessage('success', `Mix #${mixNumber} deleted successfully!`);
                autoSave();
            }
        }
        
        // Save/Load Functions
        function saveData() {
            const data = {
                calculator: getCalculatorData(),
                mixLog: getMixLogData(),
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `concrete-calculator-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showMessage('success', 'Data saved successfully!');
        }
        
        function exportData() {
            const data = {
                calculator: getCalculatorData(),
                mixLog: getMixLogData(),
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `concrete-calculator-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showMessage('success', 'Data exported successfully!');
        }
        
        function exportCSV() {
            const csvData = getMixLogCSV();
            const csvBlob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(csvBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `mix-log-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            showMessage('success', 'Mix log exported as CSV!');
        }
        
        function loadData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    setCalculatorData(data.calculator);
                    setMixLogData(data.mixLog);
                    calculate();
                    showMessage('success', 'Data loaded successfully!');
                } catch (error) {
                    showMessage('error', 'Error loading data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                // Reset calculator inputs
                document.getElementById('volume').value = '10';
                document.getElementById('ratioPortland').value = '1';
                document.getElementById('ratioSand').value = '2';
                document.getElementById('ratioWater').value = '1';
                document.getElementById('waste').value = '10';
                document.getElementById('plasticizerPercent').value = '0.21';
                document.getElementById('plasticizerEnabled').checked = true;
                document.getElementById('pigmentBlack').value = '0';
                document.getElementById('pigmentBlue').value = '0';
                document.getElementById('pigmentGreen').value = '0';
                document.getElementById('pigmentOrange').value = '0';
                document.getElementById('pigmentBrown').value = '0';
                document.getElementById('densityCement').value = '1.505';
                document.getElementById('densitySand').value = '1.602';
                document.getElementById('densityWater').value = '1.0';
                
                // Clear all mix log inputs
                const tbody = document.getElementById('logTable').getElementsByTagName('tbody')[0];
                const inputs = tbody.getElementsByTagName('input');
                for (let input of inputs) {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                }
                
                togglePlasticizer();
                calculate();
                showMessage('success', 'All data cleared!');
            }
        }
        
        function autoSave() {
            // Auto-save to localStorage for persistence
            const data = {
                calculator: getCalculatorData(),
                mixLog: getMixLogData(),
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('concreteCalculatorData', JSON.stringify(data));
        }
        
        function autoLoad() {
            const savedData = localStorage.getItem('concreteCalculatorData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    setCalculatorData(data.calculator);
                    setMixLogData(data.mixLog);
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
            }
        }
        
        function getCalculatorData() {
            return {
                volume: document.getElementById('volume').value,
                ratioPortland: document.getElementById('ratioPortland').value,
                ratioSand: document.getElementById('ratioSand').value,
                ratioWater: document.getElementById('ratioWater').value,
                waste: document.getElementById('waste').value,
                plasticizerPercent: document.getElementById('plasticizerPercent').value,
                plasticizerEnabled: document.getElementById('plasticizerEnabled').checked,
                pigmentBlack: document.getElementById('pigmentBlack').value,
                pigmentBlue: document.getElementById('pigmentBlue').value,
                pigmentGreen: document.getElementById('pigmentGreen').value,
                pigmentOrange: document.getElementById('pigmentOrange').value,
                pigmentBrown: document.getElementById('pigmentBrown').value,
                densityCement: document.getElementById('densityCement').value,
                densitySand: document.getElementById('densitySand').value,
                densityWater: document.getElementById('densityWater').value
            };
        }
        
        function setCalculatorData(data) {
            if (!data) return;
            document.getElementById('volume').value = data.volume || '10';
            document.getElementById('ratioPortland').value = data.ratioPortland || '1';
            document.getElementById('ratioSand').value = data.ratioSand || '2';
            document.getElementById('ratioWater').value = data.ratioWater || '1';
            document.getElementById('waste').value = data.waste || '10';
            document.getElementById('plasticizerPercent').value = data.plasticizerPercent || '0.21';
            document.getElementById('plasticizerEnabled').checked = data.plasticizerEnabled !== false;
            document.getElementById('pigmentBlack').value = data.pigmentBlack || '0';
            document.getElementById('pigmentBlue').value = data.pigmentBlue || '0';
            document.getElementById('pigmentGreen').value = data.pigmentGreen || '0';
            document.getElementById('pigmentOrange').value = data.pigmentOrange || '0';
            document.getElementById('pigmentBrown').value = data.pigmentBrown || '0';
            document.getElementById('densityCement').value = data.densityCement || '1.505';
            document.getElementById('densitySand').value = data.densitySand || '1.602';
            document.getElementById('densityWater').value = data.densityWater || '1.0';
            togglePlasticizer();
        }
        
        function getMixLogData() {
            const tbody = document.getElementById('logTable').getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            const data = [];
            
            for (let i = 0; i < rows.length; i++) {
                const inputs = rows[i].getElementsByTagName('input');
                const rowData = [];
                for (let j = 0; j < inputs.length; j++) {
                    if (inputs[j].type === 'checkbox') {
                        rowData.push(inputs[j].checked);
                    } else {
                        rowData.push(inputs[j].value);
                    }
                }
                data.push(rowData);
            }
            return data;
        }
        
        function setMixLogData(data) {
            if (!data || data.length === 0) return;
            
            const tbody = document.getElementById('logTable').getElementsByTagName('tbody')[0];
            const headerRow = document.getElementById('logTable').getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
            
            // Calculate how many columns we need based on saved data
            let maxColumns = 0;
            for (let i = 0; i < data.length; i++) {
                if (data[i] && data[i].length > maxColumns) {
                    maxColumns = data[i].length;
                }
            }
            
            console.log('Need columns:', maxColumns);
            
            // Add new columns if needed
            let columnsAdded = 0;
            while (columnsAdded < 20) { // Safety limit
                let currentColumns = headerRow.getElementsByTagName('th').length - 1; // Recalculate each time
                
                if (currentColumns >= maxColumns) {
                    break; // We have enough columns
                }
                
                try {
                    console.log('Adding column, currently have:', currentColumns);
                    addNewMixColumn();
                    columnsAdded++;
                } catch (error) {
                    console.error('Error adding column:', error);
                    showMessage('error', 'Error adding columns: ' + error.message);
                    break;
                }
            }
            
            // Now populate the data
            try {
                const rows = tbody.getElementsByTagName('tr');
                for (let i = 0; i < data.length && i < rows.length; i++) {
                    const inputs = rows[i].getElementsByTagName('input');
                    for (let j = 0; j < data[i].length && j < inputs.length; j++) {
                        if (inputs[j]) {
                            if (inputs[j].type === 'checkbox') {
                                inputs[j].checked = data[i][j] === true || data[i][j] === 'true';
                            } else {
                                inputs[j].value = data[i][j] || '';
                            }
                        }
                    }
                }
                
                if (columnsAdded > 0) {
                    showMessage('success', `Loaded data and created ${columnsAdded} new mix columns`);
                } else {
                    showMessage('success', 'Data loaded successfully');
                }
            } catch (error) {
                console.error('Error populating data:', error);
                showMessage('error', 'Error loading data: ' + error.message);
            }
        }
        
        function getMixLogCSV() {
            const headers = ['Parameter'];
            const parameterNames = [
                'Cast Date', 'Days Since Cast', 'Ratio (P:S:W)', 'Adjusted Volume (in¬≥)', 
                '% Pigment Total', 'Cement (g)', 'Sand (g)', 'Water (g)', 
                'Pigment Black (g)', 'Pigment Blue (g)', 'Pigment Green (g)', 
                'Pigment Orange (g)', 'Pigment Brown (g)', 'Plasticizer (g)',
                'Slurry Coat', 'Vibration Method', 'Mix Notes', '',
                'Bubble Rating (1-10)', 'Surface Quality', 'Color Evenness', 
                'Sealer Used', 'Final Impressions'
            ];
            
            // Get headers from table
            const headerRow = document.getElementById('logTable').getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
            const headerCells = headerRow.getElementsByTagName('th');
            for (let i = 1; i < headerCells.length; i++) {
                headers.push(headerCells[i].textContent.replace(/√ó/g, '').trim());
            }
            
            let csv = headers.join(',') + '\n';
            
            const tbody = document.getElementById('logTable').getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const inputs = rows[i].getElementsByTagName('input');
                let rowData = [parameterNames[i] || ''];
                
                for (let j = 0; j < inputs.length; j++) {
                    if (inputs[j].type === 'checkbox') {
                        rowData.push(inputs[j].checked ? 'Yes' : 'No');
                    } else {
                        rowData.push(inputs[j].value || '');
                    }
                }
                csv += rowData.join(',') + '\n';
            }
            
            return csv;
        }
        
        function showMessage(type, message) {
            const successElement = document.getElementById('successMessage');
            const errorElement = document.getElementById('errorMessage');
            
            // Hide both first
            successElement.style.display = 'none';
            errorElement.style.display = 'none';
            
            if (type === 'success') {
                successElement.textContent = message;
                successElement.style.display = 'block';
                setTimeout(() => successElement.style.display = 'none', 3000);
            } else {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => errorElement.style.display = 'none', 5000);
            }
        }
        
        // Initialize calculator on page load
        window.onload = function() {
            autoLoad();
            calculate();
        };
    </script>
</body>
</html>
